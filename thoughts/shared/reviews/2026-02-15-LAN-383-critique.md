---
date: 2026-02-15
linear_ticket: LAN-383
linear_url: https://linear.app/landcrawler-ai/issue/LAN-383/deterministic-workflow-management-for-ralph-hero
plan_document: ralph-hero/thoughts/shared/plans/2026-02-14-deterministic-workflow-management.md
status: approved
type: critique
---

# Plan Critique: LAN-383 - Deterministic Workflow Management for Ralph-Hero

## Overall Assessment: APPROVED

The plan is thorough, well-structured, and implementation-ready. All 6 phases are clearly defined with specific file paths, TypeScript interfaces, pseudocode logic, error handling patterns, and testable success criteria. The bottom-up strategy (tools first, then hooks, then prompt simplification, then semantic resolution, then integration testing) is sound.

## Strengths

1. **Comprehensive current state analysis**: The plan clearly separates what is already deterministic (hooks, state gates, branch enforcement) from what remains prompt-dependent (phase selection, convergence, dispatch). This makes the scope unambiguous.

2. **Phase 0 validation**: Testing `updatedInput` before committing to the hook-based approach, then pivoting to MCP server-side resolution, demonstrates good engineering discipline. The pivot is well-documented with test procedure and results.

3. **Error message design**: The three-part error structure (diagnostic, context, recovery action) with the full edge case matrix (10 scenarios across 7 commands and 5 intents) is excellent. This enables LLM self-correction without human intervention.

4. **Data consistency safeguard**: Hardcoding state data in the MCP server with a unit test for drift detection against `ralph-state-machine.json` is the right approach given the npx distribution model.

5. **Tool Reference Audit**: Cross-referencing all 20 MCP tools against SKILL.md files and agent frontmatter before adding new tools eliminates ghost reference risk.

6. **Detailed TypeScript interfaces**: All 4 new tools have complete input/output type definitions, making implementation unambiguous.

## Issues Found

### Issue 1: Unreachable HUMAN_GATE branch in detectPhase pseudocode (Minor)

In the `detectPhase` function (plan lines 163-215), the `HUMAN_GATE` check at line 190-192 is unreachable:

```typescript
// Line 184-187: Returns REVIEW if ANY planInReview or planInProgress
const planInReview = issues.filter(i => i.workflowState === "Plan in Review");
const planInProgress = issues.filter(i => i.workflowState === "Plan in Progress");
if (planInReview.length > 0 || planInProgress.length > 0) {
  return { phase: "REVIEW", ... };
}

// Line 190-192: This can NEVER execute because line 184 catches it first
if (planInReview.length === issues.length) {
  return { phase: "HUMAN_GATE", ... };
}
```

**Fix**: Reorder the conditions so the `HUMAN_GATE` check (all in "Plan in Review") comes before the generic `REVIEW` check (some in review/progress). Alternatively, nest the `HUMAN_GATE` check inside the `REVIEW` block as a subcase.

**Impact**: Low -- the pseudocode is illustrative, not copy-paste. The implementer will likely catch this during development. But it should be corrected to avoid confusion.

### Issue 2: `ralph_impl` lock_state is implicit (Minor)

The state machine JSON does NOT have `lock_state: "In Progress"` on the `ralph_impl` command (unlike `ralph_research` which has `lock_state: "Research in Progress"` and `ralph_plan` which has `lock_state: "Plan in Progress"`). However, `In Progress` is listed in the global `lock_states.states` array and the plan's `SEMANTIC_INTENTS.__LOCK__` maps `ralph_impl` to `"In Progress"`.

This works correctly because the plan hardcodes the mapping directly in `SEMANTIC_INTENTS`. But the data consistency unit test (Phase 4, lines 1135-1141) that compares hardcoded data against the JSON would fail for `ralph_impl.__LOCK__` unless the test accounts for the missing `lock_state` field by falling back to the global `lock_states.states` list.

**Fix**: Either add `"lock_state": "In Progress"` to the `ralph_impl` command in `ralph-state-machine.json` for consistency, or ensure the drift detection test handles the implicit lock state. The former is cleaner.

### Issue 3: `it.todo` stubs in unit tests (Minor)

Phase 4 unit tests include two `it.todo` stubs for data consistency tests (plan lines 1138-1141):

```typescript
it.todo("verify SEMANTIC_INTENTS matches ralph-state-machine.json semantic_states");
it.todo("verify COMMAND_ALLOWED_STATES matches ralph-state-machine.json commands");
```

These are placeholders, not implemented tests. The plan explicitly calls out drift detection as important (line 653), so these should be implemented, not left as `todo`. The implementation would need to resolve the path to `ralph-state-machine.json` relative to the test file.

**Fix**: Provide implementation guidance or pseudocode for these tests. They need to read the JSON file (which is in the plugin's hooks directory, not in the MCP server's src directory) and compare the data structures.

### Issue 4: Missing estimate on ticket (Informational)

LAN-383 has no estimate set. The review workflow expects XS/Small tickets. This is an informational note -- the ticket should get an estimate before entering the implementation queue.

## Verification Summary

| Criterion | Status |
|-----------|--------|
| All phases defined with clear changes | PASS |
| Referenced files exist | PASS (all 7 key files verified) |
| State data matches JSON | PASS (all 7 commands, 5 intents cross-checked) |
| Success criteria are specific and testable | PASS (automated + manual for each phase) |
| "What we're NOT doing" is well-defined | PASS (6 clear exclusions) |
| Error handling specified | PASS (3-part structure with 10 edge cases) |
| Migration/rollback plan | PASS (Phase 4 breaking change noted, rollback documented) |
| Phase ordering is sound | PASS (bottom-up: tools -> hooks -> prompts -> resolution -> testing) |

## Recommendation

**APPROVED** with minor notes. The three issues identified are all low-impact and can be addressed during implementation without blocking the plan. The plan is comprehensive, technically sound, and ready for phased execution.

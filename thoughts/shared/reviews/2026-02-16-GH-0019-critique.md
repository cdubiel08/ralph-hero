---
date: 2026-02-16
github_issue: 19
github_url: https://github.com/cdubiel08/ralph-hero/issues/19
plan_document: thoughts/shared/plans/2026-02-16-GH-0019-validated-handoff-ticket-tool.md
status: approved
type: critique
---

# Plan Critique: GH-19 Validated handoff_ticket Tool

## Verdict: APPROVED

The plan is thorough, well-structured, and implementable. All referenced files exist and line numbers are accurate within 1-2 lines. The 4-phase approach with clear dependencies is sound. No blocking issues found.

## Warnings

### 1. File Count Discrepancy (26 files, not 23)

The plan's Phase 3 claims 23 files need updating (7 skills + 5 agents + 11 hooks). However, `grep -r "update_workflow_state" plugin/ralph-hero/` finds **26 files** with 50 total occurrences. The missing files:

- **`plugin/ralph-hero/README.md`** (line 220): Tool listing table references `ralph_hero__update_workflow_state`
- **`plugin/ralph-hero/mcp-server/src/tools/relationship-tools.ts`** (line 734): Error message string mentions `update_workflow_state` in recovery guidance for `advance_children`

These are not blocking but will cause the Phase 3 success criterion `grep -r "update_workflow_state" plugin/ralph-hero/` to fail if left unaddressed.

### 2. Hook Script Count Math Error

Plan text says "11 hook files: hooks.json (2 matchers), plus 9 individual hook scripts" but the Phase 3 table lists **10** individual scripts (pre-github-validator, post-github-validator, state-gate, convergence-gate, auto-state, research-state-gate, review-state-gate, triage-state-gate, impl-state-gate, plan-state-gate). Internal inconsistency: 1 + 10 = 11 files total (correct count), but the text says 9 scripts.

### 3. `workflow-states.ts` Fate Unaddressed

The plan creates a `StateMachine` class with `isValidState()`, `isLockState()`, `isTerminal()`, `requiresHumanAction()` that directly overlap with `workflow-states.ts` exports (`VALID_STATES`, `LOCK_STATES`, `TERMINAL_STATES`, `HUMAN_STATES`, `isValidState()`). The plan:

- Deletes `state-resolution.ts` (fully subsumed)
- Does NOT mention `workflow-states.ts` at all

This creates confusing duplication. `workflow-states.ts` also exports `STATE_ORDER`, `stateIndex()`, `compareStates()`, `isEarlierState()` for pipeline ordering (used by `issue-tools.ts` and `relationship-tools.ts` for pipeline detection) which the StateMachine does NOT cover. So the file can't simply be deleted.

**Recommendation**: The implementer should either (a) import the overlapping helpers from StateMachine into `workflow-states.ts` to keep a single source of truth, or (b) add a comment in `workflow-states.ts` noting the overlap. This is a debt item, not a blocker.

### 4. Command Name Format Internals Unclear

The `handoff_ticket` tool accepts bare command names (`research`, `plan`, etc.) but the StateMachine's `DEFAULT_CONFIG` is described as having "7 commands" without specifying whether keys are `ralph_research` or `research`. The existing `normalizeCommand()` in `state-resolution.ts` handles both formats, but that file is being deleted.

The implementer needs to decide: does the StateMachine store `ralph_`-prefixed keys (matching the JSON) and normalize at the tool level, or store bare keys and update the JSON/tests? Either works, but the plan should have been explicit.

### 5. Minor Line Number Drift

- `registerIssueTools` call: plan says index.ts:293, actual is index.ts:291
- `resolveIssueNodeId` in relationship-tools.ts: plan says lines 27-52, actual ends at line 55
- These are close enough for implementation but noted for precision.

### 6. Pre-existing Data Inconsistency

`workflow-states.ts` defines `HUMAN_STATES = ["Human Needed", "Plan in Review"]` but the state machine JSON marks 3 states with `requires_human_action: true`: Human Needed, Plan in Review, **and In Review**. The plan's Phase 4 test spec correctly lists all 3 states. This isn't a plan issue but a pre-existing codebase inconsistency the implementer should be aware of.

## What's Good

- **Excellent phase structure**: 4 phases with explicit dependencies, clear "Depends on" tags
- **Line-specific code references**: Every change pinpoints exact file + line range, mostly accurate
- **Comprehensive success criteria**: Each phase has automated AND manual verification checklists
- **Clean separation of concerns**: Pure `StateMachine` (no I/O) vs `handoff_ticket` tool (I/O + validation)
- **Smart design choice**: Embed config as TypeScript defaults, use JSON consistency tests for drift prevention
- **Good deduplication**: `resolveIssueNodeId` extraction eliminates real copy-paste between issue-tools and relationship-tools
- **Thoughtful "What We're NOT Doing"**: Clear scope boundaries, explicit `__REJECT__` deferral
- **Performance analysis**: Correctly identifies 1 extra API call per transition, within rate limits
- **Comprehensive test migration**: Preserves all 259 lines of existing test cases from state-resolution.test.ts

## Summary

The plan is ready for implementation. An experienced implementer can handle the warnings (2 missing files, workflow-states overlap, command name normalization) without needing the plan rewritten. The core architecture (StateMachine class, handoff_ticket tool, phased rollout, test migration) is sound and well-specified.

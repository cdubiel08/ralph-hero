---
date: 2026-02-27
github_issue: 452
github_url: https://github.com/cdubiel08/ralph-hero/issues/452
plan_document: thoughts/shared/plans/2026-02-27-GH-0452-build-save-issue-tool.md
status: approved
type: critique
---

# Critique: GH-452 Build Unified `save_issue` Tool

## Summary

The plan is well-structured, technically sound, and implementable. All referenced files, functions, and patterns exist at the stated locations. The plan correctly identifies the two mutation paths (repo vs project tokens), the aliased batch pattern, and the clear-vs-set distinction. Three minor issues need attention during implementation but do not block approval.

## Verification of Technical Claims

### Confirmed

| Claim | Location | Verified |
|-------|----------|----------|
| `buildBatchMutationQuery` exists and is already exported | `batch-tools.ts:86` | Yes -- exported at line 86 |
| `update_issue` tool | `issue-tools.ts:969-1074` | Yes -- exact lines confirmed |
| `update_workflow_state` tool | `issue-tools.ts:1079-1174` | Yes -- exact lines confirmed |
| `update_estimate` tool | `issue-tools.ts:1179-1232` | Yes -- exact lines confirmed |
| `update_priority` tool | `issue-tools.ts:1237-1290` | Yes -- exact lines confirmed |
| `clear_field` tool | `project-management-tools.ts:374-442` | Yes -- exact lines confirmed |
| `resolveState` in state-resolution.ts | `state-resolution.ts:75` | Yes -- line 75 |
| `resolveConfig` helper | `lib/helpers.ts:471` | Yes -- line 471 |
| `resolveFullConfig` helper | `lib/helpers.ts:513` | Yes -- line 513 |
| `resolveIssueNodeId` helper | `lib/helpers.ts:127` | Yes |
| `resolveProjectItemId` helper | `lib/helpers.ts:161` | Yes |
| `syncStatusField` helper | `lib/helpers.ts:569-597` | Yes -- exact lines confirmed |
| `WORKFLOW_STATE_TO_STATUS` mapping | `workflow-states.ts:117-129` | Yes -- exact lines confirmed |
| Dual-token split (`mutate` vs `projectMutate`) | `github-client.ts:87-97` | Yes -- lines 87-97, separate graphql instances |
| `TERMINAL_STATES` constant | `workflow-states.ts:27` | Yes -- `["Done", "Canceled"]` |
| Label resolution pattern | `issue-tools.ts:1007-1028` | Yes -- exact lines confirmed |
| `clearProjectV2ItemFieldValue` mutation pattern | `project-management-tools.ts:419-430` | Yes -- exact lines confirmed |

### Issue: `buildBatchMutationQuery` Already Exported

The plan's Change #5 (line 302-306) says to "Add `export` to `buildBatchMutationQuery` at line 86 (if not already exported)." It IS already exported. The plan acknowledges this possibility ("Check: if already exported, no change needed"), so this is a no-op. No action required for this change item.

## Issues Found

### Issue 1: Non-existent `invalidateMutationCaches()` method (Low severity)

**Plan reference**: Pseudocode step 6, line 242: `client.cache.invalidateMutationCaches()`

**Reality**: This method does not exist anywhere in the codebase. Cache invalidation happens automatically inside `client.mutate()` and `client.projectMutate()` -- both call `cache.invalidatePrefix("query:")` before executing the mutation (see `github-client.ts:246,255`).

**Impact**: The pseudocode step 6 is a no-op that would cause a runtime error if implemented literally. However, since cache invalidation is already handled by the mutation methods, the correct behavior is to simply omit this step. The only project-level tool that manually invalidates is `setup_project` (`project-tools.ts:1373`), which is a special case.

**Resolution**: During implementation, skip step 6 entirely. The `mutate()` and `projectMutate()` calls in steps 3 and 5 already invalidate query caches.

### Issue 2: `resolveState` requires `command` but schema makes it optional (Low severity)

**Plan reference**: Schema at line 114-115 declares `command` as optional. Pseudocode line 138 calls `resolveState(args.workflowState, args.command)`.

**Reality**: `resolveState(state: string, rawCommand: string)` in `state-resolution.ts:75` requires `rawCommand` as a non-optional string. It validates the command against `COMMAND_ALLOWED_STATES` and throws if unknown. Passing `undefined` would throw "Unknown command".

**Impact**: If a user calls `save_issue(number: 123, workflowState: "In Progress")` without `command`, the `resolveState` call will fail.

**Resolution**: During implementation, either:
- (a) Make `command` required when `workflowState` is provided (runtime validation before calling `resolveState`), or
- (b) Skip `resolveState` validation when `command` is omitted and `workflowState` is a direct state name (bypass the per-command validation). This would allow setting any valid workflow state without command context, which is a reasonable UX for `save_issue`.

Option (b) is recommended -- it makes `save_issue` more flexible for ad-hoc use while still supporting semantic intents when `command` is provided.

### Issue 3: `assignees` parameter has no ID resolution (Informational)

**Plan reference**: Schema at line 104 includes `assignees: z.array(z.string())` for GitHub usernames.

**Reality**: The existing `update_issue` tool at line 1060 passes `assigneeIds: null` with the comment "Would need username -> ID resolution". Username-to-ID resolution is not implemented anywhere in the codebase.

**Impact**: The `assignees` parameter cannot be implemented without adding a new GraphQL query to resolve usernames to node IDs. This is additional scope not called out in the plan.

**Resolution**: Either implement username-to-ID resolution (small addition: query `user(login: $username) { id }` for each assignee), or defer `assignees` to a future iteration and document it in "What We're NOT Doing". This is minor scope creep either way.

## Completeness Assessment

- **Phases**: Single phase, clearly defined with 6 change items.
- **Files touched**: All identified correctly. File paths use the correct `src/lib/` prefix for helpers.
- **Success criteria**: Both automated and manual criteria are specific and testable.
- **What we're NOT doing**: Well-scoped -- old tool removal, skill updates, and other tools are explicitly excluded.
- **Test strategy**: Comprehensive -- schema validation, auto-close logic, semantic intents, and structural tests.
- **Key implementation notes**: All 6 notes are accurate and actionable.

## Feasibility Assessment

The plan is feasible as a Small (S) estimate. The core work is:
1. New tool registration with Zod schema (~40 lines)
2. Handler with two mutation paths (~100 lines pseudocode, ~150 lines actual)
3. One new helper for field clearing (~15 lines)
4. Test file (~150 lines)

Total: ~350 lines of new code, all following established patterns.

## Verdict: APPROVED

The three issues identified are minor and can be resolved during implementation without changing the plan's architecture or scope. The plan correctly identifies all relevant patterns, helpers, and mutation paths. Line number references are accurate across all files.

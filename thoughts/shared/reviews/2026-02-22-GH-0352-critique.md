---
date: 2026-02-22
github_issue: 352
github_url: https://github.com/cdubiel08/ralph-hero/issues/352
plan_document: thoughts/shared/plans/2026-02-22-group-GH-0352-v4-architecture-specification.md
status: approved
type: critique
---

# Plan Critique: V4 Architecture Specification (GH-352 Group)

## Summary Assessment

This is a well-structured 10-phase group plan covering the V4 architecture rollout for the ralph-hero plugin. It spans communication discipline, upfront task list model, roster spawning, agent self-claim, hero mode migration, interactive skill verification, and observability tooling. The plan correctly incorporates Phase 0 research findings and provides actionable code snippets with file paths for each change.

**Verdict: APPROVED** -- the plan is ready for implementation with minor notes below.

## Strengths

1. **Research alignment is excellent.** Every key finding from the Phase 0 investigation (`2026-02-23-GH-0352-v4-primitive-investigation.md`) is directly addressed:
   - `blockedBy` advisory behavior -> Phase 3 updates `worker-stop-gate.sh` guidance (lines 258-269)
   - Self-claim race condition -> Phase 5 implements claim-then-verify in all 4 agent definitions (lines 377-393)
   - Idle workers cannot self-detect tasks -> Phase 4 uses interleaved create-assign-spawn (Option A) to avoid the issue entirely (lines 333-351)
   - `suggestedRoster` feasibility -> Phase 4 adds the interface and heuristic to `pipeline-detection.ts` (lines 286-331)

2. **Line number references are accurate.** Spot-checked against actual files:
   - `conventions.md` "TaskUpdate Protocol" section ends around line 35 -> plan inserts Communication Discipline after it (correct)
   - `SKILL.md` Section 4.2 "Bough Model" starts at line 160 -> plan replaces it (correct)
   - `pipeline-detection.ts` PipelinePosition interface at lines 42-50 -> plan adds SuggestedRoster after it (correct)
   - `buildResult()` at lines 365-392 -> plan inserts roster computation there (correct)
   - `index.ts` main() at line 288 -> confirmed (correct)
   - `worker-stop-gate.sh` guidance at lines 35-39 -> confirmed (correct)
   - `team-task-completed.sh` multi-line guidance at lines 22-27 and 29-34 -> confirmed (correct)

3. **All referenced files exist.** Verified all 17+ files listed in the plan:
   - All 4 agent definitions (`ralph-analyst.md`, `ralph-builder.md`, `ralph-validator.md`, `ralph-integrator.md`)
   - All skill files (`ralph-hero/SKILL.md`, `ralph-team/SKILL.md`, `create-plan/SKILL.md`, `iterate-plan/SKILL.md`, `implement-plan/SKILL.md`, `draft-idea/SKILL.md`, `research-codebase/SKILL.md`)
   - Core MCP files (`pipeline-detection.ts`, `github-client.ts`, `index.ts`)
   - Hook scripts (`team-task-completed.sh`, `worker-stop-gate.sh`)
   - Shared conventions (`conventions.md`)

4. **Phase dependencies are well-defined and sequential.** Phases 1-5 form a strict chain (research -> communication -> task model -> roster -> self-claim), Phases 6-8 build on Phase 5, and Phases 9-10 are additive observability.

5. **Scope boundaries are clear.** The "What We're NOT Doing" section explicitly excludes runtime SDK changes, transport layer changes, Linear integration, state machine changes, and multi-project handling -- all reasonable exclusions.

6. **Phase 8 (GH-359) correctly identifies a verification-only pass.** The plan acknowledges all three skills already exist and are complete, proposing to close with no code changes if verification passes.

7. **Success criteria are specific and testable.** Each phase has automated grep checks and manual verification items.

## Issues Found

### Minor Issues (non-blocking)

1. **Phase 9 claims "all 10 `register*()` functions" but there are 11.** The `registerCoreTools()` function is defined inline in `index.ts` (line 127), not in a separate tool file. The 10 files in `src/tools/` each have their own register function, plus `registerCoreTools` in `index.ts`. The `withLogging` wrapper should also be applied to `registerCoreTools` for completeness. This is a minor arithmetic issue -- the implementer will see the inline function and handle it.

2. **Phase 4 interleaved startup vs Phase 0 research wake recommendation.** The Phase 0 research (Section 0c) recommends either Option A (interleaved) or Option B (roster-first + SendMessage wake). The plan correctly chooses Option A but the Communication Discipline section (Phase 2) does not include the SendMessage wake carve-out that the research recommends (Section 0c conclusion: "The Communication Discipline rule should explicitly carve out this exception"). Since Option A avoids the need for wake messages, this is not a functional issue, but if the implementer ever falls back to Option B, the carve-out would be needed. Consider adding a note.

3. **Phase 3 `worker-stop-gate.sh` change is guidance-only, not enforcement.** The plan updates the stderr text to mention "unblocked" tasks but does not add actual `blockedBy` checking logic to the script. The research explicitly found that `blockedBy` is advisory and the stop hook "does NOT check blockedBy -- it only emits guidance." The plan's approach (update guidance text, rely on agent definitions to check `blockedBy` in the self-claim loop) is pragmatically sound since the agents are the ones doing the actual claiming, but it is worth noting that the hook remains a guidance mechanism, not an enforcement mechanism.

4. **Phase 6 hero mode removes `run_in_background` but the replacement execution model is underspecified.** The plan says "Spawn all unblocked tasks simultaneously (multiple `Task()` calls in one message, foreground)" but hero mode is a solo orchestrator, not a team. The plan does not clarify whether hero mode uses `TeamCreate` or operates as a single agent with `Task()` sub-agents. The existing hero mode uses `run_in_background=true` for parallelism. The replacement should clarify the concurrency model.

5. **Phase numbering in plan vs issue numbering.** The plan uses "Phase 1" through "Phase 10" but the phases are offset from the issue numbers (Phase 1 = GH-352, Phase 2 = GH-353, etc.). This is internally consistent but could cause confusion when cross-referencing. The plan headers do include the issue number, mitigating this.

## Verdict

**APPROVED.** The plan is comprehensive, well-researched, and actionable. All file references are verified, line numbers are accurate, and the Phase 0 research findings are correctly incorporated into the design. The minor issues noted above are informational and do not block implementation. The plan can proceed to implementation as-is.

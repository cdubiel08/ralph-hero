# Ralph Hero - LLM-powered workflow recipes
#
# Usage: just <recipe> [params...]
# Prerequisites: claude CLI, timeout (coreutils), just >= 1.37
# Optional: mcptools (https://github.com/f/mcptools) for quick-* recipes

set shell := ["bash", "-euc"]
set dotenv-load
set tempdir := "/tmp"

# Aliases for frequently-used recipes
alias t  := triage
alias r  := research
alias p  := plan
alias i  := impl
alias s  := status
alias sp := split
alias h  := hygiene
alias issue := quick-info

# Browse and run a recipe interactively (falls back to --list without fzf)
default:
    #!/usr/bin/env bash
    if command -v fzf >/dev/null 2>&1; then
        just --choose
    else
        just --list
    fi

# Triage a backlog issue - assess validity, close duplicates, route to research
[group('workflow')]
triage issue="" budget="1.00" timeout="15m":
    @just _run_skill "triage" "{{issue}}" "{{budget}}" "{{timeout}}"

# Split a large issue into smaller XS/S sub-issues
[group('workflow')]
split issue="" budget="1.00" timeout="15m":
    @just _run_skill "split" "{{issue}}" "{{budget}}" "{{timeout}}"

# Research an issue - investigate codebase, create findings document
[group('workflow')]
research issue="" budget="2.00" timeout="15m":
    @just _run_skill "research" "{{issue}}" "{{budget}}" "{{timeout}}"

# Create implementation plan from research findings
[group('workflow')]
plan issue="" budget="3.00" timeout="15m":
    @just _run_skill "plan" "{{issue}}" "{{budget}}" "{{timeout}}"

# Review and critique an implementation plan
[group('workflow')]
review issue="" budget="2.00" timeout="15m":
    @just _run_skill "review" "{{issue}}" "{{budget}}" "{{timeout}}"

# Implement an issue following its approved plan
[group('workflow')]
impl issue="" budget="5.00" timeout="15m":
    @just _run_skill "impl" "{{issue}}" "{{budget}}" "{{timeout}}"

# Run project hygiene check - stale items, archive candidates
[group('workflow')]
hygiene budget="0.50" timeout="10m":
    @just _run_skill "hygiene" "" "{{budget}}" "{{timeout}}"

# Display pipeline status dashboard with health indicators
[group('workflow')]
status budget="0.50" timeout="10m":
    @just _run_skill "status" "" "{{budget}}" "{{timeout}}"

# Generate and post a project status report
[group('workflow')]
report issue="" budget="1.00" timeout="10m":
    @just _run_skill "report" "{{issue}}" "{{budget}}" "{{timeout}}"

# Multi-agent team coordinator - spawns specialist workers
[group('orchestrate')]
team issue="" budget="10.00" timeout="30m":
    RALPH_BUDGET="{{budget}}" TIMEOUT="{{timeout}}" ./scripts/ralph-team-loop.sh {{issue}}

# Tree-expansion orchestrator - drives issue through full lifecycle
[group('orchestrate')]
hero issue="" budget="10.00" timeout="30m":
    @just _run_skill "hero" "{{issue}}" "{{budget}}" "{{timeout}}"

# Sequential autonomous loop - hygiene, triage, split, research, plan, review, impl
[group('orchestrate')]
loop mode="all" review="skip" split="auto" hygiene="auto" budget="5.00" timeout="60m":
    #!/usr/bin/env bash
    set -eu
    args=""
    if [ "{{mode}}" != "all" ]; then args="--{{mode}}-only"; fi
    args="$args --review={{review}} --split={{split}} --hygiene={{hygiene}}"
    RALPH_BUDGET="{{budget}}" TIMEOUT="{{timeout}}" ./scripts/ralph-loop.sh $args

# One-time project setup - create GitHub Project V2 with required fields
[group('setup')]
setup budget="1.00" timeout="10m":
    @just _run_skill "setup" "" "{{budget}}" "{{timeout}}"

# Diagnose setup issues - checks env, deps, plugin manifest, and API connectivity
[group('setup')]
doctor:
    #!/usr/bin/env bash
    set -eu
    errors=0; warnings=0
    echo "=== Ralph Doctor ==="
    echo ""
    echo "--- Environment Variables ---"
    for var in RALPH_HERO_GITHUB_TOKEN RALPH_GH_OWNER RALPH_GH_PROJECT_NUMBER; do
        if [ -z "${!var:-}" ]; then
            echo "FAIL: $var is not set"
            errors=$((errors + 1))
        else
            if [ "$var" = "RALPH_HERO_GITHUB_TOKEN" ]; then
                echo "  OK: $var (set, redacted)"
            else
                echo "  OK: $var = ${!var}"
            fi
        fi
    done
    echo ""
    echo "--- Dependencies ---"
    for cmd in just npx node; do
        if command -v "$cmd" &>/dev/null; then
            echo "  OK: $cmd ($(command -v "$cmd"))"
        else
            echo "FAIL: $cmd not found"
            errors=$((errors + 1))
        fi
    done
    if command -v mcp &>/dev/null; then
        echo "  OK: mcp (mcptools)"
    else
        echo "WARN: mcp (mcptools) not installed -- quick-* recipes unavailable"
        echo "      Install: brew tap f/mcptools && brew install mcp"
        warnings=$((warnings + 1))
    fi
    if command -v claude &>/dev/null; then
        echo "  OK: claude CLI"
    else
        echo "WARN: claude CLI not found -- LLM-powered recipes unavailable"
        warnings=$((warnings + 1))
    fi
    echo ""
    echo "--- Plugin Files ---"
    if [ -f .claude-plugin/plugin.json ]; then
        if node -e "JSON.parse(require('fs').readFileSync('.claude-plugin/plugin.json','utf8'))" 2>/dev/null; then
            echo "  OK: .claude-plugin/plugin.json (valid JSON)"
        else
            echo "FAIL: .claude-plugin/plugin.json (invalid JSON)"
            errors=$((errors + 1))
        fi
    else
        echo "FAIL: .claude-plugin/plugin.json not found"
        errors=$((errors + 1))
    fi
    if [ -f .mcp.json ]; then
        if node -e "JSON.parse(require('fs').readFileSync('.mcp.json','utf8'))" 2>/dev/null; then
            echo "  OK: .mcp.json (valid JSON)"
        else
            echo "FAIL: .mcp.json (invalid JSON)"
            errors=$((errors + 1))
        fi
    else
        echo "FAIL: .mcp.json not found"
        errors=$((errors + 1))
    fi
    echo ""
    if command -v mcp &>/dev/null && [ -n "${RALPH_HERO_GITHUB_TOKEN:-}" ]; then
        echo "--- API Health Check ---"
        just _mcp_call "ralph_hero__health_check" '{}' || {
            echo "FAIL: API health check failed"
            errors=$((errors + 1))
        }
        echo ""
    else
        echo "--- API Health Check ---"
        echo "SKIP: mcptools or RALPH_HERO_GITHUB_TOKEN not available"
        echo ""
    fi
    echo "--- WSL2 Compatibility ---"
    if grep -qi microsoft /proc/version 2>/dev/null; then
        echo "  WSL2 detected"
        tempdir="${JUST_TEMPDIR:-/tmp}"
        if mount | grep -q "on $tempdir.*noexec"; then
            echo "WARN: $tempdir is mounted noexec â€” shebang recipes will fail"
            echo "      Fix: export JUST_TEMPDIR=/tmp"
            warnings=$((warnings + 1))
        else
            echo "  OK: tempdir ($tempdir) supports exec"
        fi
    else
        echo "  OK: Not WSL2 (no shebang restrictions)"
    fi
    echo ""
    echo "=== Summary: $errors error(s), $warnings warning(s) ==="
    if [ "$errors" -gt 0 ]; then exit 1; fi

# Install global 'ralph' command - run from anywhere after setup
[group('setup')]
[confirm('This will install ralph to ~/.local/bin/ralph (overwriting if exists). Continue?')]
install-cli:
    #!/usr/bin/env bash
    set -eu
    PLUGIN_DIR="{{justfile_directory()}}"
    BIN_DIR="$HOME/.local/bin"
    mkdir -p "$BIN_DIR"
    cp "$PLUGIN_DIR/scripts/ralph-cli.sh" "$BIN_DIR/ralph"
    chmod +x "$BIN_DIR/ralph"
    echo "Installed: $BIN_DIR/ralph"
    echo "  Resolves latest plugin version at runtime from:"
    echo "  ~/.claude/plugins/cache/ralph-hero/ralph-hero/"
    if ! echo "$PATH" | tr ':' '\n' | grep -qx "$BIN_DIR"; then
        echo ""
        echo "WARNING: $BIN_DIR is not in your PATH."
        echo "Add to your shell profile (~/.bashrc or ~/.zshrc):"
        echo "  export PATH=\"\$HOME/.local/bin:\$PATH\""
    fi
    echo ""
    echo "Usage: ralph <recipe> [args...]"
    echo "  ralph triage 42"
    echo "  ralph loop"
    echo "  ralph team 42"
    echo "For tab completions: just install-completions bash  (or zsh)"

# Remove global 'ralph' command
[group('setup')]
[confirm('Are you sure you want to uninstall the ralph CLI?')]
uninstall-cli:
    #!/usr/bin/env bash
    set -eu
    BIN_DIR="$HOME/.local/bin"
    if [ -f "$BIN_DIR/ralph" ]; then
        rm "$BIN_DIR/ralph"
        echo "Removed: $BIN_DIR/ralph"
        # Clean up legacy symlink if present
        CONFIG_DIR="$HOME/.config/ralph-hero"
        if [ -L "$CONFIG_DIR/justfile" ]; then
            rm "$CONFIG_DIR/justfile"
            echo "Removed legacy symlink: $CONFIG_DIR/justfile"
        fi
        if [ -d "$CONFIG_DIR" ] && [ -z "$(ls -A "$CONFIG_DIR")" ]; then
            rmdir "$CONFIG_DIR"
        fi
        echo "Ralph CLI uninstalled."
    else
        echo "Nothing to uninstall -- ralph CLI was not installed."
    fi

# Install shell completions for the global 'ralph' command
[group('setup')]
[confirm('This will install shell completions (overwriting if exists). Continue?')]
install-completions shell="bash":
    #!/usr/bin/env bash
    set -eu
    PLUGIN_DIR="{{justfile_directory()}}"
    case "{{shell}}" in
        bash)
            COMP_DIR="$HOME/.local/share/bash-completion/completions"
            mkdir -p "$COMP_DIR"
            cp "$PLUGIN_DIR/scripts/ralph-completions.bash" "$COMP_DIR/ralph"
            echo "Installed bash completions: $COMP_DIR/ralph"
            echo "Restart your shell or run: source $COMP_DIR/ralph"
            ;;
        zsh)
            COMP_DIR="$HOME/.local/share/zsh/site-functions"
            mkdir -p "$COMP_DIR"
            cp "$PLUGIN_DIR/scripts/ralph-completions.zsh" "$COMP_DIR/_ralph"
            echo "Installed zsh completions: $COMP_DIR/_ralph"
            echo "Restart your shell or run: source $COMP_DIR/_ralph"
            ;;
        *)
            echo "Unsupported shell: {{shell}}. Use 'bash' or 'zsh'."
            exit 1
            ;;
    esac

# Generate shell tab completions (bash, zsh, fish, powershell, elvish)
[group('setup')]
completions shell="bash":
    @just --completions {{shell}}

# Pipeline status dashboard - instant, no API cost
[group('quick')]
quick-status format="markdown":
    @just _mcp_call "ralph_hero__pipeline_dashboard" \
        '{"format":"{{format}}","includeHealth":true}'

# Move issue to a workflow state - instant, no API cost
[group('quick')]
quick-move issue state:
    @just _mcp_call "ralph_hero__update_workflow_state" \
        '{"number":{{issue}},"state":"{{state}}","command":"ralph_cli"}'

# Find next actionable issue by workflow state - instant, no API cost
[group('quick')]
quick-pick state="Research Needed" max-estimate="S":
    @just _mcp_call "ralph_hero__pick_actionable_issue" \
        '{"workflowState":"{{state}}","maxEstimate":"{{max-estimate}}"}'

# Assign issue to a GitHub user - instant, no API cost
[group('quick')]
quick-assign issue user:
    @just _mcp_call "ralph_hero__update_issue" \
        '{"number":{{issue}},"assignees":["{{user}}"]}'

# Create a new issue with project fields - instant, no API cost
[group('quick')]
quick-issue title label="" priority="" estimate="" state="Backlog":
    #!/usr/bin/env bash
    set -eu
    params='{"title":"{{title}}"'
    if [ -n "{{label}}" ]; then params="$params,\"labels\":[\"{{label}}\"]"; fi
    if [ -n "{{priority}}" ]; then params="$params,\"priority\":\"{{priority}}\""; fi
    if [ -n "{{estimate}}" ]; then params="$params,\"estimate\":\"{{estimate}}\""; fi
    params="$params,\"workflowState\":\"{{state}}\"}"
    just _mcp_call "ralph_hero__create_issue" "$params"

# Get full issue details with project fields - instant, no API cost
[group('quick')]
quick-info issue:
    @just _mcp_call "ralph_hero__get_issue" \
        '{"number":{{issue}}}'

# Add a comment to an issue - instant, no API cost
[group('quick')]
quick-comment issue body:
    @just _mcp_call "ralph_hero__create_comment" \
        '{"number":{{issue}},"body":"{{body}}"}'

# Create a draft issue on the project board (no GitHub issue, just a card)
[group('quick')]
quick-draft title priority="" estimate="" state="Backlog":
    #!/usr/bin/env bash
    set -eu
    params='{"title":"{{title}}"'
    if [ -n "{{priority}}" ]; then params="$params,\"priority\":\"{{priority}}\""; fi
    if [ -n "{{estimate}}" ]; then params="$params,\"estimate\":\"{{estimate}}\""; fi
    params="$params,\"workflowState\":\"{{state}}\"}"
    just _mcp_call "ralph_hero__create_draft_issue" "$params"

[private]
_run_skill skill issue budget timeout:
    #!/usr/bin/env bash
    set -eu
    if [ -n "{{issue}}" ]; then
        cmd="/ralph-hero:ralph-{{skill}} {{issue}}"
    else
        cmd="/ralph-hero:ralph-{{skill}}"
    fi
    echo ">>> Running: $cmd (budget: \${{budget}}, timeout: {{timeout}})"
    if timeout "{{timeout}}" claude -p "$cmd" \
        --max-budget-usd "{{budget}}" \
        --dangerously-skip-permissions \
        2>&1; then
        echo ">>> Completed: $cmd"
    else
        exit_code=$?
        if [ $exit_code -eq 124 ]; then
            echo ">>> Timed out after {{timeout}}"
            echo "    The skill did not complete within the time limit."
            echo "    Try: just {{skill}} timeout=30m   (increase timeout)"
        else
            echo ">>> Exited with code $exit_code"
            echo "    Check above for error details from the skill output."
            echo "    Common causes: API token expired, budget exhausted, network error."
            echo "    Run: just doctor   to diagnose environment issues."
        fi
    fi

[private]
_mcp_call tool params:
    #!/usr/bin/env bash
    set -eu
    if ! command -v mcp &>/dev/null; then
        echo "Error: mcptools not installed."
        echo "Install: brew tap f/mcptools && brew install mcp"
        echo "   or: go install github.com/f/mcptools/cmd/mcptools@latest"
        exit 1
    fi
    raw=$(mcp call "{{tool}}" --params '{{params}}' \
        npx -y ralph-hero-mcp-server@2.4.80)
    if command -v jq &>/dev/null; then
        if echo "$raw" | jq -e '.isError // false' > /dev/null 2>&1; then
            echo "$raw" | jq -r '.content[0].text' >&2
            exit 1
        fi
        echo "$raw" | jq -r '.content[0].text // .' | jq '.' 2>/dev/null \
            || echo "$raw" | jq -r '.content[0].text // .'
    else
        echo "$raw"
    fi

# Advance linked issues' Workflow State on PR merge.
#
# When a PR is merged, issues referenced via closing keywords
# (Closes #N, Fixes #N, Resolves #N) have their Workflow State advanced:
#   - In Progress → In Review
#   - In Review   → Done
#   - Other states → skip (no backward movement)
#
# Uses closingIssuesReferences GraphQL query as primary method,
# with PR body regex parsing as fallback.
#
# The built-in project automation handles the default Status field;
# this workflow only touches the custom Workflow State field.
#
# Requires ROUTING_PAT secret: classic PAT with repo + project scopes.
# GITHUB_TOKEN cannot access Projects V2.

name: Advance Linked Issues on PR Merge

on:
  pull_request:
    types: [closed]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to process'
        required: true
        type: number

concurrency:
  group: pr-merge-${{ github.event.pull_request.number || inputs.pr_number }}
  cancel-in-progress: false

jobs:
  advance-linked-issues:
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.ROUTING_PAT }}
      PROJECT_OWNER: ${{ vars.RALPH_PROJECT_OWNER || 'cdubiel08' }}
      PROJECT_NUMBER: ${{ vars.RALPH_PROJECT_NUMBER || '3' }}
    steps:
      - name: Find linked issues
        id: linked
        env:
          EVENT_NAME: ${{ github.event_name }}
          PR_NUMBER_EVENT: ${{ github.event.pull_request.number }}
          PR_NUMBER_INPUT: ${{ inputs.pr_number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            PR_NUMBER="$PR_NUMBER_INPUT"
          else
            PR_NUMBER="$PR_NUMBER_EVENT"
          fi
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"

          # Primary: closingIssuesReferences GraphQL query
          ISSUE_NUMBERS=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $pr: Int!) {
              repository(owner: $owner, name: $repo) {
                pullRequest(number: $pr) {
                  closingIssuesReferences(first: 25) {
                    nodes { number }
                  }
                }
              }
            }' -f owner="$REPO_OWNER" -f repo="$REPO_NAME" -F pr="$PR_NUMBER" \
               --jq '[.data.repository.pullRequest.closingIssuesReferences.nodes[].number] | join(" ")' 2>/dev/null || echo "")

          # Fallback: parse PR body for closing keywords
          # Note: PR body is untrusted input — only used with grep to extract
          # numeric issue references, never interpolated into commands.
          if [ -z "$ISSUE_NUMBERS" ]; then
            echo "closingIssuesReferences returned empty — falling back to PR body parsing"
            PR_BODY=$(gh api graphql -f query='
              query($owner: String!, $repo: String!, $pr: Int!) {
                repository(owner: $owner, name: $repo) {
                  pullRequest(number: $pr) { body }
                }
              }' -f owner="$REPO_OWNER" -f repo="$REPO_NAME" -F pr="$PR_NUMBER" \
                 --jq '.data.repository.pullRequest.body // empty')

            ISSUE_NUMBERS=$(echo "$PR_BODY" | grep -oiP '(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s*:?\s*#\K\d+' | sort -u | tr '\n' ' ')
          fi

          if [ -z "$ISSUE_NUMBERS" ]; then
            echo "No linked issues found for PR #$PR_NUMBER — nothing to advance"
            echo "issues=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "issues=$ISSUE_NUMBERS" >> "$GITHUB_OUTPUT"
          echo "Found linked issues: $ISSUE_NUMBERS"

      - name: Resolve project ID and field options
        if: steps.linked.outputs.issues != ''
        id: project
        run: |
          RESULT=$(gh api graphql -f query='
            query($owner: String!, $number: Int!) {
              user(login: $owner) {
                projectV2(number: $number) {
                  id
                  fields(first: 50) {
                    nodes {
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        options { id name }
                      }
                    }
                  }
                }
              }
            }' -f owner="$PROJECT_OWNER" -F number="$PROJECT_NUMBER")

          PROJECT_ID=$(echo "$RESULT" | jq -r '.data.user.projectV2.id')
          if [ "$PROJECT_ID" = "null" ] || [ -z "$PROJECT_ID" ]; then
            # Try organization type
            RESULT=$(gh api graphql -f query='
              query($owner: String!, $number: Int!) {
                organization(login: $owner) {
                  projectV2(number: $number) {
                    id
                    fields(first: 50) {
                      nodes {
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options { id name }
                        }
                      }
                    }
                  }
                }
              }' -f owner="$PROJECT_OWNER" -F number="$PROJECT_NUMBER")
            PROJECT_ID=$(echo "$RESULT" | jq -r '.data.organization.projectV2.id')
          fi

          if [ "$PROJECT_ID" = "null" ] || [ -z "$PROJECT_ID" ]; then
            echo "::error::Could not find project $PROJECT_OWNER/$PROJECT_NUMBER"
            exit 1
          fi

          echo "project_id=$PROJECT_ID" >> "$GITHUB_OUTPUT"

          FIELD_ID=$(echo "$RESULT" | jq -r '.. | objects | select(.name == "Workflow State") | .id' | head -1)
          if [ -z "$FIELD_ID" ] || [ "$FIELD_ID" = "null" ]; then
            echo "::error::Workflow State field not found in project"
            exit 1
          fi
          echo "field_id=$FIELD_ID" >> "$GITHUB_OUTPUT"

          # Extract option IDs for the two possible target states
          IN_REVIEW_ID=$(echo "$RESULT" | jq -r --arg name "In Review" \
            '.. | objects | select(.name == "Workflow State") | .options[] | select(.name == $name) | .id' | head -1)
          DONE_ID=$(echo "$RESULT" | jq -r --arg name "Done" \
            '.. | objects | select(.name == "Workflow State") | .options[] | select(.name == $name) | .id' | head -1)

          echo "in_review_option_id=$IN_REVIEW_ID" >> "$GITHUB_OUTPUT"
          echo "done_option_id=$DONE_ID" >> "$GITHUB_OUTPUT"
          echo "Resolved: project=$PROJECT_ID, field=$FIELD_ID, In Review=$IN_REVIEW_ID, Done=$DONE_ID"

      - name: Advance each linked issue
        if: steps.linked.outputs.issues != ''
        env:
          PROJECT_ID: ${{ steps.project.outputs.project_id }}
          FIELD_ID: ${{ steps.project.outputs.field_id }}
          IN_REVIEW_OPTION_ID: ${{ steps.project.outputs.in_review_option_id }}
          DONE_OPTION_ID: ${{ steps.project.outputs.done_option_id }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          LINKED_ISSUES: ${{ steps.linked.outputs.issues }}
        run: |
          ERRORS=0
          for ISSUE_NUM in $LINKED_ISSUES; do
            echo "--- Processing issue #$ISSUE_NUM ---"

            # Resolve issue node ID
            ISSUE_NODE_ID=$(gh api graphql -f query='
              query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $number) { id }
                }
              }' -f owner="$REPO_OWNER" -f repo="$REPO_NAME" -F number="$ISSUE_NUM" \
                 --jq '.data.repository.issue.id' 2>/dev/null || echo "")

            if [ -z "$ISSUE_NODE_ID" ] || [ "$ISSUE_NODE_ID" = "null" ]; then
              echo "::warning::Could not resolve issue #$ISSUE_NUM — skipping"
              ERRORS=$((ERRORS + 1))
              continue
            fi

            # Find project item
            ITEM_ID=$(gh api graphql -f query='
              query($issueId: ID!) {
                node(id: $issueId) {
                  ... on Issue {
                    projectItems(first: 20) {
                      nodes {
                        id
                        project { id }
                      }
                    }
                  }
                }
              }' -f issueId="$ISSUE_NODE_ID" \
                 --jq --arg pid "$PROJECT_ID" \
                 '.data.node.projectItems.nodes[] | select(.project.id == $pid) | .id' 2>/dev/null || echo "")

            if [ -z "$ITEM_ID" ] || [ "$ITEM_ID" = "null" ]; then
              echo "::warning::Issue #$ISSUE_NUM is not in project — skipping"
              continue
            fi

            # Read current Workflow State
            CURRENT=$(gh api graphql -f query='
              query($itemId: ID!) {
                node(id: $itemId) {
                  ... on ProjectV2Item {
                    fieldValueByName(name: "Workflow State") {
                      ... on ProjectV2ItemFieldSingleSelectValue {
                        name
                      }
                    }
                  }
                }
              }' -f itemId="$ITEM_ID" \
                 --jq '.data.node.fieldValueByName.name // empty' 2>/dev/null || echo "")

            echo "Issue #$ISSUE_NUM current state: ${CURRENT:-<unset>}"

            # Determine target state and option ID
            TARGET=""
            OPTION_ID=""
            case "$CURRENT" in
              "In Progress")
                TARGET="In Review"
                OPTION_ID="$IN_REVIEW_OPTION_ID"
                ;;
              "In Review")
                TARGET="Done"
                OPTION_ID="$DONE_OPTION_ID"
                ;;
              *)
                echo "Issue #$ISSUE_NUM in '$CURRENT' — not advanceable by PR merge, skipping"
                continue
                ;;
            esac

            # Update Workflow State
            gh api graphql -f query='
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId,
                  itemId: $itemId,
                  fieldId: $fieldId,
                  value: { singleSelectOptionId: $optionId }
                }) {
                  projectV2Item { id }
                }
              }' -f projectId="$PROJECT_ID" \
                 -f itemId="$ITEM_ID" \
                 -f fieldId="$FIELD_ID" \
                 -f optionId="$OPTION_ID"

            echo "Advanced issue #$ISSUE_NUM: $CURRENT → $TARGET"
          done

          if [ "$ERRORS" -gt 0 ]; then
            echo "::warning::$ERRORS issue(s) could not be processed"
          fi

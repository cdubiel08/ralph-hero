# Sync Workflow State on issue close/reopen events.
#
# When an issue is closed or reopened via the GitHub UI, this workflow
# updates the custom "Workflow State" field in the Ralph project:
#   - closed (completed)    → Done
#   - closed (not_planned)  → Canceled
#   - closed (duplicate)    → Canceled
#   - closed (unknown)      → Canceled
#   - reopened              → Backlog
#
# The built-in project automation handles the default Status field;
# this workflow only touches the custom Workflow State field.
#
# Requires ROUTING_PAT secret: classic PAT with repo + project scopes.
# GITHUB_TOKEN cannot access Projects V2.

name: Sync Workflow State on Close/Reopen

on:
  issues:
    types: [closed, reopened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number
      target_state:
        description: 'Target Workflow State'
        required: true
        type: choice
        options:
          - Done
          - Canceled
          - Backlog

concurrency:
  group: sync-issue-${{ github.event.issue.number || inputs.issue_number }}
  cancel-in-progress: false

jobs:
  sync-workflow-state:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.ROUTING_PAT }}
      PROJECT_OWNER: ${{ vars.RALPH_PROJECT_OWNER || 'cdubiel08' }}
      PROJECT_NUMBER: ${{ vars.RALPH_PROJECT_NUMBER || '3' }}
    steps:
      - name: Determine target state
        id: target
        env:
          EVENT_NAME: ${{ github.event_name }}
          EVENT_ACTION: ${{ github.event.action }}
          EVENT_ISSUE_NUMBER: ${{ github.event.issue.number }}
          EVENT_STATE_REASON: ${{ github.event.issue.state_reason }}
          INPUT_ISSUE_NUMBER: ${{ inputs.issue_number }}
          INPUT_TARGET_STATE: ${{ inputs.target_state }}
        run: |
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            echo "state=$INPUT_TARGET_STATE" >> "$GITHUB_OUTPUT"
            echo "issue_number=$INPUT_ISSUE_NUMBER" >> "$GITHUB_OUTPUT"
            echo "Manual dispatch: target=$INPUT_TARGET_STATE, issue=#$INPUT_ISSUE_NUMBER"
            exit 0
          fi

          echo "issue_number=$EVENT_ISSUE_NUMBER" >> "$GITHUB_OUTPUT"

          if [ "$EVENT_ACTION" = "reopened" ]; then
            echo "state=Backlog" >> "$GITHUB_OUTPUT"
            echo "Issue #$EVENT_ISSUE_NUMBER reopened → Backlog"
          elif [ "$EVENT_STATE_REASON" = "completed" ]; then
            echo "state=Done" >> "$GITHUB_OUTPUT"
            echo "Issue #$EVENT_ISSUE_NUMBER closed (completed) → Done"
          else
            echo "state=Canceled" >> "$GITHUB_OUTPUT"
            echo "Issue #$EVENT_ISSUE_NUMBER closed ($EVENT_STATE_REASON) → Canceled"
          fi

      - name: Resolve project ID and field options
        id: project
        env:
          TARGET_STATE: ${{ steps.target.outputs.state }}
        run: |
          RESULT=$(gh api graphql -f query='
            query($owner: String!, $number: Int!) {
              user(login: $owner) {
                projectV2(number: $number) {
                  id
                  fields(first: 50) {
                    nodes {
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        options { id name }
                      }
                    }
                  }
                }
              }
            }' -f owner="$PROJECT_OWNER" -F number="$PROJECT_NUMBER")

          PROJECT_ID=$(echo "$RESULT" | jq -r '.data.user.projectV2.id')
          if [ "$PROJECT_ID" = "null" ] || [ -z "$PROJECT_ID" ]; then
            # Try organization type
            RESULT=$(gh api graphql -f query='
              query($owner: String!, $number: Int!) {
                organization(login: $owner) {
                  projectV2(number: $number) {
                    id
                    fields(first: 50) {
                      nodes {
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options { id name }
                        }
                      }
                    }
                  }
                }
              }' -f owner="$PROJECT_OWNER" -F number="$PROJECT_NUMBER")
            PROJECT_ID=$(echo "$RESULT" | jq -r '.data.organization.projectV2.id')
          fi

          if [ "$PROJECT_ID" = "null" ] || [ -z "$PROJECT_ID" ]; then
            echo "::error::Could not find project $PROJECT_OWNER/$PROJECT_NUMBER"
            exit 1
          fi

          echo "project_id=$PROJECT_ID" >> "$GITHUB_OUTPUT"

          # Extract Workflow State field ID and target option ID
          FIELD_ID=$(echo "$RESULT" | jq -r '.. | objects | select(.name == "Workflow State") | .id' | head -1)
          if [ -z "$FIELD_ID" ] || [ "$FIELD_ID" = "null" ]; then
            echo "::error::Workflow State field not found in project"
            exit 1
          fi
          echo "field_id=$FIELD_ID" >> "$GITHUB_OUTPUT"

          OPTION_ID=$(echo "$RESULT" | jq -r --arg name "$TARGET_STATE" \
            '.. | objects | select(.name == "Workflow State") | .options[] | select(.name == $name) | .id' | head -1)
          if [ -z "$OPTION_ID" ] || [ "$OPTION_ID" = "null" ]; then
            echo "::error::Workflow State option '$TARGET_STATE' not found"
            exit 1
          fi
          echo "option_id=$OPTION_ID" >> "$GITHUB_OUTPUT"
          echo "Resolved: project=$PROJECT_ID, field=$FIELD_ID, option=$OPTION_ID ($TARGET_STATE)"

      - name: Resolve project item for issue
        id: item
        env:
          ISSUE_NUMBER: ${{ steps.target.outputs.issue_number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          PROJECT_ID: ${{ steps.project.outputs.project_id }}
        run: |
          # Get issue node ID
          ISSUE_NODE_ID=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $number: Int!) {
              repository(owner: $owner, name: $repo) {
                issue(number: $number) { id }
              }
            }' -f owner="$REPO_OWNER" \
               -f repo="$REPO_NAME" \
               -F number="$ISSUE_NUMBER" \
               --jq '.data.repository.issue.id')

          if [ -z "$ISSUE_NODE_ID" ] || [ "$ISSUE_NODE_ID" = "null" ]; then
            echo "::error::Could not resolve issue #$ISSUE_NUMBER"
            exit 1
          fi

          # Find project item
          ITEM_ID=$(gh api graphql -f query='
            query($issueId: ID!) {
              node(id: $issueId) {
                ... on Issue {
                  projectItems(first: 20) {
                    nodes {
                      id
                      project { id }
                    }
                  }
                }
              }
            }' -f issueId="$ISSUE_NODE_ID" \
               --jq --arg pid "$PROJECT_ID" \
               '.data.node.projectItems.nodes[] | select(.project.id == $pid) | .id')

          if [ -z "$ITEM_ID" ] || [ "$ITEM_ID" = "null" ]; then
            echo "::warning::Issue #$ISSUE_NUMBER is not in project — skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "item_id=$ITEM_ID" >> "$GITHUB_OUTPUT"
          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "Resolved project item: $ITEM_ID"

      - name: Check current state and update
        if: steps.item.outputs.skip != 'true'
        env:
          ITEM_ID: ${{ steps.item.outputs.item_id }}
          TARGET_STATE: ${{ steps.target.outputs.state }}
          ISSUE_NUMBER: ${{ steps.target.outputs.issue_number }}
          PROJECT_ID: ${{ steps.project.outputs.project_id }}
          FIELD_ID: ${{ steps.project.outputs.field_id }}
          OPTION_ID: ${{ steps.project.outputs.option_id }}
        run: |
          # Read current Workflow State
          CURRENT=$(gh api graphql -f query='
            query($itemId: ID!) {
              node(id: $itemId) {
                ... on ProjectV2Item {
                  fieldValueByName(name: "Workflow State") {
                    ... on ProjectV2ItemFieldSingleSelectValue {
                      name
                    }
                  }
                }
              }
            }' -f itemId="$ITEM_ID" \
               --jq '.data.node.fieldValueByName.name // empty')

          echo "Current Workflow State: ${CURRENT:-<unset>}"

          if [ "$CURRENT" = "$TARGET_STATE" ]; then
            echo "Already at target state '$TARGET_STATE' — no-op"
            exit 0
          fi

          # Update Workflow State
          gh api graphql -f query='
            mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
              updateProjectV2ItemFieldValue(input: {
                projectId: $projectId,
                itemId: $itemId,
                fieldId: $fieldId,
                value: { singleSelectOptionId: $optionId }
              }) {
                projectV2Item { id }
              }
            }' -f projectId="$PROJECT_ID" \
               -f itemId="$ITEM_ID" \
               -f fieldId="$FIELD_ID" \
               -f optionId="$OPTION_ID"

          echo "Updated issue #$ISSUE_NUMBER: $CURRENT → $TARGET_STATE"
